#!/bin/bash
MODE=${1:-default}

function install_git {
    tmpfile=$(mktemp 2>/dev/null||mktemp -t tmp)
    rm -rf $tmpfile
    mkdir -p $tmpfile
    trap "[[ $tmpfile ]] && rm -rf $tmpfile" 0

    curl -L "https://www.kernel.org/pub/software/scm/git/git-${1}.tar.gz" | tar xz -C $tmpfile --strip=1 --no-same-permission --no-same-owner
    cd $tmpfile
    make prefix=${2} all
    make prefix=${2} install
}

function install_emacs {
    tmpfile=$(mktemp 2>/dev/null||mktemp -t tmp)
    rm -rf $tmpfile
    mkdir -p $tmpfile
    trap "[[ $tmpfile ]] && rm -rf $tmpfile" 0

    curl -L "http://ftp.gnu.org/pub/gnu/emacs/emacs-${1}.tar.gz" | tar xz -C $tmpfile --strip=1 --no-same-permission --no-same-owner
    cd $tmpfile
    ./configure --prefix=${2} --without-x --without-selinux
    make
    make install
}

function install_cask {
    curl -fsSL https://raw.githubusercontent.com/cask/cask/master/go | python
}

function setup_default {
    echo "Create symbolic link files"
    cd $(dirname $0)

    for filename in .?*; do
        case $filename in
            '..' | '.git' | '.DS_Store')
                continue;;
            *.example)
                echo "${PWD}/${filename} -> ${HOME}/${filename%.*}"
                cp -i "${PWD}/${filename}" "${HOME}/${filename%.*}"
                continue;;
            *)
                echo "${PWD}/${filename} -> ${HOME}/${filename}"
                rm -rf "${HOME}/${filename}"
                ln -Fis "${PWD}/${filename}" $HOME
                ;;
        esac
    done
    echo ""

    echo "Run cask"
    cd "${HOME}/.emacs.d"
    cask
}

case $MODE in
    git)
        install_git ${2:-2.5.3} ${3:-$HOME/local}
        ;;
    emacs)
        install_emacs ${2:-24.5} ${3:-$HOME/local}
        ;;
    cask)
        install_cask
        ;;
    default)
        setup_default
        ;;
    *)
        echo "'${MODE}' is not support mode"
        ;;
esac
